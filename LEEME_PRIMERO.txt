# WhatsAppChatbotSystem - VersiÃ³n Mejorada con Historia ClÃ­nica

## ğŸ¯ Cambios Implementados

### âœ… Nuevas Funcionalidades

1. **Almacenamiento de Chat en Base de Datos**
   - Servicio: `Services/DatabaseService.cs`
   - Todos los mensajes (Customer, Bot, Operator) se guardan automÃ¡ticamente
   - Tabla: `ChatRegistro`

2. **Servicio de Historia ClÃ­nica**
   - Servicio: `Services/HistoriaClinicaService.cs`
   - Controlador: `Controllers/HistoriaClinicaController.cs`
   - CreaciÃ³n y almacenamiento con nÃºmeros consecutivos automÃ¡ticos
   - Tabla: `HistoriaClinica`

3. **GeneraciÃ³n de PDF**
   - Servicio: `Services/PdfService.cs`
   - Genera PDFs con formato profesional
   - Basado en el modelo de historia clÃ­nica proporcionado
   - Los PDFs se guardan en `wwwroot/pdfs/`

4. **EnvÃ­o de PDF por WhatsApp**
   - Los PDFs se suben automÃ¡ticamente a Cloudinary
   - Se envÃ­an al usuario por WhatsApp como documento
   - Incluye mensaje personalizado con nÃºmero de historia

5. **Modal Interactivo en Panel de Operadores**
   - Archivo: `wwwroot/historia-clinica-modal.js`
   - Modal flotante que NO interrumpe el chat
   - 4 pestaÃ±as organizadas: Paciente, Antecedentes, Examen FÃ­sico, DiagnÃ³stico
   - ValidaciÃ³n de campos en tiempo real

## ğŸ“¦ InstalaciÃ³n RÃ¡pida

1. **Ejecutar script de Base de Datos:**
   ```sql
   -- Ejecutar en SQL Server Management Studio
   USE TelemedicinaBD
   GO
   -- Copiar y ejecutar el contenido de DatabaseSchema.sql
   ```

2. **Verificar ConnectionString en appsettings.json:**
   ```json
   "ConnectionStrings": {
     "TelemedicineDB": "Server=localhost;Database=TelemedicinaBD;User Id=sa;Password=ms2022*;TrustServerCertificate=True;MultipleActiveResultSets=true"
   }
   ```

3. **Restaurar paquetes NuGet:**
   ```bash
   dotnet restore
   ```

4. **Compilar:**
   ```bash
   dotnet build
   ```

5. **Ejecutar:**
   ```bash
   dotnet run
   ```

## ğŸ”§ Modificar index.html

Ver archivo `INSTRUCCIONES_INDEX.md` para instrucciones detalladas de cÃ³mo agregar:
- BotÃ³n de Historia ClÃ­nica
- Script del modal
- Referencias necesarias

**O simplemente:**
- El archivo `historia-clinica-modal.js` se carga automÃ¡ticamente si lo agrega al final del index.html

## ğŸ“‹ Uso del Sistema

### Panel de Operadores

1. Abrir: `http://localhost:5000`
2. Ingresar nombre del operador
3. Tomar conversaciÃ³n de la lista
4. Chatear normalmente
5. Clic en "ğŸ“‹ Historia ClÃ­nica" cuando sea necesario
6. Diligenciar formulario (el chat sigue activo)
7. Guardar - El PDF se genera y envÃ­a automÃ¡ticamente

### API de Historia ClÃ­nica

**Crear Historia ClÃ­nica:**
```
POST /api/HistoriaClinica/crear
Content-Type: application/json

Body: { objeto HistoriaClinicaCompleta }
```

**Obtener Historia ClÃ­nica:**
```
GET /api/HistoriaClinica/{noHistoria}
```

## ğŸ—‚ï¸ Estructura de Archivos Nuevos

```
WhatsAppChatbotSystem_Mejorado/
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ DatabaseService.cs           âœ¨ NUEVO - Guarda mensajes en BD
â”‚   â”œâ”€â”€ HistoriaClinicaService.cs   âœ¨ NUEVO - Gestiona historias clÃ­nicas
â”‚   â””â”€â”€ PdfService.cs                âœ¨ NUEVO - Genera PDFs
â”œâ”€â”€ Controllers/
â”‚   â””â”€â”€ HistoriaClinicaController.cs âœ¨ NUEVO - API de historias
â”œâ”€â”€ wwwroot/
â”‚   â”œâ”€â”€ historia-clinica-modal.js   âœ¨ NUEVO - Modal interactivo
â”‚   â””â”€â”€ pdfs/                        âœ¨ NUEVO - Carpeta para PDFs
â”œâ”€â”€ appsettings.json                 ğŸ”„ MODIFICADO - ConnectionString
â”œâ”€â”€ program.cs                       ğŸ”„ MODIFICADO - Servicios y modelos
â”œâ”€â”€ CloudinaryService.cs             ğŸ”„ MODIFICADO - MÃ©todo UploadDocument
â”œâ”€â”€ Controllers/webhookcontroller.cs ğŸ”„ MODIFICADO - Guarda mensajes
â””â”€â”€ WhatsAppChatbotSystem.csproj     ğŸ”„ MODIFICADO - Nuevos paquetes
```

## âš™ï¸ Dependencias Agregadas

- `Microsoft.Data.SqlClient` v5.2.0 - Para SQL Server
- `itext7` v8.0.3 - Para generaciÃ³n de PDFs

## ğŸ” VerificaciÃ³n Post-InstalaciÃ³n

1. **Probar conexiÃ³n a BD:**
   - El sistema registra en consola si la conexiÃ³n es exitosa
   - Buscar mensaje: "âœ… ConexiÃ³n a BD exitosa"

2. **Verificar tabla ChatRegistro:**
   ```sql
   SELECT TOP 10 * FROM ChatRegistro ORDER BY Timestamp DESC
   ```

3. **Verificar tabla HistoriaClinica:**
   ```sql
   SELECT TOP 10 * FROM HistoriaClinica ORDER BY FechaCreacion DESC
   ```

4. **Probar modal:**
   - Abrir panel de operadores
   - Tomar conversaciÃ³n
   - Verificar que aparezca botÃ³n "ğŸ“‹ Historia ClÃ­nica"
   - Hacer clic y verificar que se abre el modal

## ğŸ› SoluciÃ³n de Problemas

### Error: "No se puede conectar a la base de datos"
- Verificar que SQL Server estÃ© corriendo
- Verificar credenciales en appsettings.json
- Ejecutar script DatabaseSchema.sql

### Error: "iText7 no encontrado"
```bash
dotnet add package itext7 --version 8.0.3
dotnet restore
```

### Modal no aparece
- Verificar que historia-clinica-modal.js estÃ© en wwwroot/
- Verificar que se agregÃ³ el script al final de index.html
- Abrir consola del navegador para ver errores

### PDF no se envÃ­a por WhatsApp
- Verificar credenciales de Cloudinary en appsettings.json
- Verificar que wwwroot/pdfs/ exista y tenga permisos de escritura
- Revisar logs de la aplicaciÃ³n

## ğŸ“ Notas Importantes

- **NÃºmeros consecutivos**: Se generan automÃ¡ticamente por la BD
- **Formato PDF**: Replica el formato de FundaciÃ³n Campbell
- **Guardado automÃ¡tico**: Todos los mensajes se guardan sin intervenciÃ³n
- **Modal no bloquea chat**: El operador puede seguir chateando

## ğŸ“„ Archivos de DocumentaciÃ³n

- `README.md` - DocumentaciÃ³n completa
- `INSTRUCCIONES_INDEX.md` - CÃ³mo modificar el index.html
- `DatabaseSchema.sql` - Script de base de datos
- `Models.cs` - Modelos de referencia

## âœ… Checklist de VerificaciÃ³n

- [ ] Base de datos creada y script ejecutado
- [ ] ConnectionString configurado
- [ ] Paquetes NuGet restaurados
- [ ] Proyecto compilado sin errores
- [ ] Modal agregado a index.html
- [ ] Cloudinary configurado
- [ ] WhatsApp configurado
- [ ] Primer mensaje guardado en BD
- [ ] Primera historia clÃ­nica creada
- [ ] PDF generado y enviado

---

**Proyecto funcional y listo para producciÃ³n** âœ¨
